# Growth Data

Importing Packages
```{r}
library(tidyverse)
library(dplyr)
library(dunn.test)
library(ggplot2)
library(cowplot)
library(survival)
library(PAmeasures)
library(survminer)
```

Reading in Data
```{r}
NIN_Size <- read.csv("NIN_End.csv")%>%
  select(Line, Bag.Number, Oyster.Number, Length) %>%
  mutate(Type = ifelse(Line == "CL1" | Line == "CL2", "Commercial", "Wild")) %>%
  filter(!is.na(Length)) %>%
  rename(Bag = Bag.Number, Oyster = Oyster.Number) %>%
  mutate(Bag = as.factor(Bag)) %>%
  mutate(Oyster = as.factor(Oyster)) %>%
  group_by(Line, Bag) %>%
  mutate(Site = "Ninigret") %>%
  mutate(Year = "2023")
WIC_Size <- read.csv("WIC_End.csv")%>%
  select(Line, Bag.., Oyster.., Length) %>%
  mutate(Type = ifelse(Line == "CL1" | Line == "CL2", "Commercial", "Wild")) %>%
  filter(!is.na(Length)) %>%
  rename(Bag = Bag.., Oyster = Oyster..) %>%
  mutate(Bag = as.factor(Bag)) %>%
  mutate(Oyster = as.factor(Oyster)) %>%
  group_by(Line, Bag) %>%
  mutate(Site = "Wickford") %>%
  mutate(Year = "2023")
Year1 <- read.csv("RWU.csv") %>%
  #Renaming commercial lines to keep them anonymous
  mutate(Line = recode(Line, FI="CL1", NEH="CL2")) %>%
  #Fixing a mistake in the sheet where lineage was accidentally entered as "Mv" instead of "MV"
  mutate(Line = recode(Line, Mv="MV")) %>%
  #Keeping only oysters recored at the end of the study.
  filter(Date == "19-Oct-22") %>%
  #Removing oysters with missing tags
  filter(Pit.Tag.End.Num != "no tag") %>%
  filter(!is.na(Length)) %>%
  #Keeping only relevant information
  select(Date, Line, Length, Bag.Number, Status, Pit.Tag.End.Num) %>%
  #Defining oysters as either wild or commercial
  mutate(Type = ifelse(Line == "CL1" | Line == "CL2", "Commercial", "Wild")) %>%
  mutate(Bag = as.factor(Bag.Number)) %>%
  mutate(Oyster = Pit.Tag.End.Num) %>%
  mutate(Survived = ifelse(Status == "Alive" | Status == "alive" | Status =="alive, no pic", 1, 0)) %>%
  mutate(Survived = as.numeric(Survived)) %>%
  mutate(Length = as.numeric(Length)) %>%
  filter(!is.na(Length)) %>%
  filter(Survived != 0) %>%
  mutate(Year = "2022") %>%
  mutate(Site = "RWU") %>%
  select(Line, Bag, Oyster, Length, Type, Site, Year)
RWU_Size <- Year1  %>%
  filter(Line != "NR") %>%
  filter(Line != "CT")
All_data <- rbind(NIN_Size, RWU_Size, WIC_Size) %>% rename(Population = Line)
Data_2023 <- rbind(NIN_Size, WIC_Size) %>% rename(Population = Line)
```
Using all populations for Year 1
```{r}
shapiro.test(Year1$Length)
kruskal.test(Year1$Length ~ Year1$Line)
dunn.test(Year1$Length, g=Year1$Line, method = "bonferroni")
```

Determining if Population affects size
```{r}
shapiro.test(All_data$Length)
kruskal.test(All_data$Length ~ All_data$Population)
dunn.test(All_data$Length, g = All_data$Population, method  = "bonferroni")
```

Determining if Site affects size
```{r}
shapiro.test(All_data$Length)
kruskal.test(All_data$Length ~ All_data$Site)
dunn.test(All_data$Length, g = All_data$Site, method  = "bonferroni")
```

Using 2023 data to see if there is an effect of Population and Site for one year
```{r}
PopandSite2023 <- lm(log(Length) ~ Site+Population, data = Data_2023)
PopxSite2023 <- lm(log(Length) ~ Site*Population, data = Data_2023)
summary(PopxSite2023)
anova(PopandSite2023, PopxSite2023)
```

Determining the Effects of Populaton and Site for 2022 and 2023
```{r}
PopandSite <- lm(log(Length) ~ Site+Population, data = All_data)
PopxSite <- lm(log(Length) ~ Site*Population, data = All_data)
summary(PopxSite)
anova(PopandSite, PopxSite)
```

Plotting Size for all sites and populations
```{r}
RWU_plot <- ggplot(RWU_Size, aes(x=Line, y=Length, fill = Type))+
  geom_boxplot()+
  labs(x = "Populations", y="Size (mm)")+
  ggtitle("Oyster Size (RWU)")+
  ylim(0,100)

NIN_plot <- ggplot(NIN_Size, aes(x=Line, y=Length, fill = Type))+
  geom_boxplot()+
  labs(x = "Populations", y="Size (mm)")+
  ggtitle("Oyster Size (Ninigret)")+
  ylim(0,100)

WIC_plot <- ggplot(WIC_Size, aes(x=Line, y=Length, fill = Type))+
  geom_boxplot()+
  labs(x = "Populations", y="Size (mm)")+
  ggtitle("Oyster Size (Wickford)")+
  ylim(0,100)

plot_grid(NIN_plot, WIC_plot, RWU_plot, nrow = 1, ncol =3)
```

## Survival Data
```{r}
WIC_Surv <- read.csv("WIC_Survival.csv")
NIN_Surv <- read.csv("NIN_Survival.csv")
Y1_Surv <- read.csv("RWU_Survival.csv") 
RWU_Surv <- Y1_Surv %>%
  filter(Population != "CT") %>%
  filter(Population != "NR")
All_Surv <- rbind(WIC_Surv, NIN_Surv, RWU_Surv)
Surv_2023 <- rbind(WIC_Surv, NIN_Surv)
```

Because we only have one replicate for survival for some populations we cannot do statistics on percent survival, instead we will use the survival curve to determine effects of Population and Site
```{r}
SurvPop <- survreg(Surv(Age, Status) ~ Population, data = All_Surv, dist = "weibull")
summary(SurvPop)
SurvSite <- survreg(Surv(Age, Status) ~ Site, data = All_Surv, dist = "weibull")
summary(SurvSite)
SurvPopandSite <- survreg(Surv(Age, Status) ~ Population+Site, data = All_Surv, dist = "weibull")
SurvPopxSite <- survreg(Surv(Age, Status) ~ Population*Site, data = All_Surv, dist = "weibull")
summary(SurvPopxSite)
#fitted_values <- SurvPopxSite$linear.predictors
#resids <- (log(SurvPopxSite$y[, 1]) - fitted_values) / SurvPopxSite$scale
#resKM <- survfit(Surv(resids, Status) ~ 1, data = All_Surv)
#plot(resKM, mark.time = FALSE, xlab = "AFT Residuals", ylab = "Survival Probability")
#xx <- seq(min(resids), max(resids), length.out = 35)
#yy <- exp(- exp(xx))
#lines(xx, yy, col = "red", lwd = 2)
#legend("bottomleft", c("KM estimate", "95% CI KM estimate", 
#    "Survival function of Extreme Value distribution"), 
#    lty = c(1,2,1), col = c(1,1,2), bty = "n")
#p <- predict(SurvPopxSite, type = "response")
#with(All_Surv, pam.censor(Age, p, Status))
```
Survival Using Year 1 oysters
Using all populations for Year 1
```{r}
Surv2022 <- survreg(Surv(Age, Status) ~ Population, data = Y1_Surv, dist = "weibull")
summary(Surv2022)
Y1_data <- data.frame(Population = c("CL1","CL2","CT","GH","MV","NR"))
surv <- seq(.99, .01, by = -.01)
t1 <- predict(Surv2022, type = "quantile", p = 1 - surv, newdata = Y1_data)
Y1_wbmod <- cbind(Y1_data, t1) %>%
  pivot_longer(names_to = "surv_id", values_to = "time", cols = -c(1:2)) %>%
  mutate(
    surv_id = as.factor(as.numeric(surv_id))) %>%
  data.frame()
Y1_wbmod$surv = surv[as.numeric(Y1_wbmod$surv_id)]
Y1_wbmod$upper = NA
Y1_wbmod$lower = NA
Y1_wbmod$std.err = NA
Y1_wbmod$strata = NA
Y1_wbmod[, c("upper", "lower", "std.err", "strata")] <- NA
#Plotting probability of survival
ggsurvplot_df(Y1_wbmod, surv.geom = geom_line,
              color = "Population", legend.title = NULL, legend = c("right"), title = "Survival Time",
              break.time.by = 1)
```

Testing if there is an effect of site and population on survival
```{r}
SurvPopxSite2023 <- survreg(Surv(Age, Status) ~ Population*Site, data = Surv_2023, dist = "weibull")
NIN_survmod <- survreg(Surv(Age, Status) ~ Population, data = NIN_Surv, dist = "weibull")
WIC_survmod <- survreg(Surv(Age, Status) ~ Population, data = WIC_Surv, dist = "weibull")
Y2_data <- data.frame(Population = c("CL1","CL2","GH","MV"))
surv <- seq(.99, .01, by = -.01)
t1 <- predict(SurvPopxSite2023, type = "quantile", p = 1 - surv, newdata = NIN_Surv)
summary(SurvPopxSite2023)
```

## Disease Data
```{r}
#Reading in disease data
Disease <- read.csv("Disease2022.csv") %>% mutate(Lineage = recode(Lineage, FI="CL1", NEH="CL2")) %>%
  mutate(Type = ifelse(Lineage == "CL1" | Lineage == "CL2", "Commercial", "Wild")) %>%
#Creating columns for disease prevalence
  subset(Sample.ID != 'NR-209') %>%
  group_by(Lineage, Type) %>%
  mutate(Dermo_Infected = ifelse(Dermo.Intensity > 0, 1, 0)) %>%
  mutate(MSX_Infected = ifelse(MSX.Intensity > 0, 1, 0)) %>%
  mutate(SSO_Infected = ifelse(SSO.Intensity > 0, 1, 0)) 
```

Statistical test on disease intensity
```{r}
shapiro.test(Disease$Dermo.Intensity)
kruskal.test(Disease$Dermo.Intensity ~ Disease$Lineage)
dunn.test(Disease$Dermo.Intensity, g = Disease$Lineage, method  = "bonferroni")
shapiro.test(Disease$MSX.Intensity)
kruskal.test(Disease$MSX.Intensity ~ Disease$Lineage)
dunn.test(Disease$MSX.Intensity, g = Disease$Lineage, method  = "bonferroni")
```

Statistical test for disease prevalence
```{r}
shapiro.test(Disease$Dermo_Infected)
kruskal.test(Disease$Dermo_Infected ~ Disease$Lineage)
shapiro.test(Disease$MSX_Infected)
kruskal.test(Disease$MSX_Infected ~ Disease$Lineage)
```

Plotting disease intensity for Dermo and MSX
```{r}
ggplot(Disease, aes(x= Lineage, y=Dermo.Intensity, fill = Type))+
  geom_boxplot()+
  ggtitle("Dermo Intensity at 19 Months")
ggplot(Disease, aes(x= Lineage, y=MSX.Intensity, fill = Type))+
  geom_boxplot()+
  ylim(0,5)+
  ggtitle("MSX Intensity at 19 Months")
```

##Yield
```{r}

```

```{r}
Avg_Yield <- rbind(WIC_Yield, NIN_Yield, RWU_Yield) %>%
  group_by(Line, Site, Type) %>%
  summarize(Avg_yield = mean(Yield))

```

