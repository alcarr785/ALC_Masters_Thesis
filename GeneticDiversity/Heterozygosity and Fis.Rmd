# Heterozygosity and Fis

The following code was used to analyze genetic diversity and inbreeding using the vcf file generated from the Filtering protocol. The steps used to calculate heterozygosity and Fis follow a [workflow developed by Jon Puritz](https://marineevoecolab.github.io/NACE_MAS_Genomics_Workshop/)\
\## Importing Data

VCF was used to read in data from the filtered VCF file

```{r}
library(vcfR)
RISG <- read.vcfR("../Filtering/RISG.vcf")
```

We need a sample table for further analysis and to get a list of populations

```{r}
library(tidyverse)
Samples <- read.table("Samples.txt", header = TRUE) %>% 
  mutate(Population = recode(Population, FI = 'CL1', NEH = 'CL2'))
poplist.names <- Samples$Population
```

## Calculating and Plotting Heterozygosity

To calculate heterozygosity we used the genetic_diff tool from vcfR

```{r}
het_results <- genetic_diff(RISG, pop=as.factor(poplist.names), method= 'nei')
round(colMeans(het_results[,c(3:8)], na.rm = TRUE), digits = 3)
```

To plot Heterozygosity we need to change the dataframe into one that can be plotted using ggplot

```{r}
library(reshape2)
het_df <- melt(het_results[,c(3:8)], varnames=c('Index', 'Sample'), value.name = 'Heterozygosity', na.rm=TRUE) %>%
  mutate(variable = recode(variable, Hs_CL1 = 'CL1', Hs_CL2 = 'CL2', Hs_MV = "MV", Hs_NR = "NR", Hs_GH = "GH", Hs_CT = "CT")) %>%
  mutate(Type = ifelse(variable == "CL1" | variable == "CL2", "Commercial", "Wild"))
```

Seeing if Heterozygosity is significant

```{r}
#First we test for normality using a Kolmogorov-Smirnov Test
lapply(split(het_df$Heterozygosity, het_df$variable), ks.test, "pnorm")
#The data is not normally distributed, we should proceed with a Kruskall test
kruskal.test(het_df$Heterozygosity ~ het_df$variable)
#The populations are significantly different, we should use a Dunn-Test post-hoc
library(dunn.test)
dunn.test(het_df$Heterozygosity, g = het_df$variable, method  = "bonferroni")
```

Plotting Heterozygosity with ggplot

```{r}
library(ggplot2)
Het <- ggplot(het_df, aes(x=variable, y=Heterozygosity, fill = Type)) + geom_boxplot() +
  xlab("Population")+
  ylab("Observed Heterozygosity")+
  ggtitle("Observed Heterozygosity") + ylim(0,1)
plot(Het)
```

Plotting Heterozygosity with Histograms
```{r}
HetHist <- ggplot(aes(x=Heterozygosity, col=I("black"), fill=Type), data = het_df) +   geom_histogram(binwidth = 0.05) +
          facet_wrap(~ variable)
plot(HetHist)
```

## Calculating and Plotting Fis

The --het function from Plink can be used to calculate F coefficient per individual. To calculate Fis, we need to use --het at a population level, which requires he plink file to be divided into multiple plink files by population. This can be done using a for loop and the --keep-fam funcion.
```{bash}
for pop in {FI,MV,CT,NR,NEH,GH}; do plink --file ../../Filtering/RISG.all.f --chr-
set 94 --allow-extra-chr --keep-fam ../../Filtering/$pop.samples --recode --out
$pop.f; done
```

Next we do het for each population level plink file.
```{bash}
for pop in {FI,MV,CT,NR,NEH,GH}; do plink --file $pop.f --chr-set 94 --allow-extra-chr --het --out $pop; done
```

Now we create a file that contains Fis for all individuals
```{bash}
head -1 CT.het > FIS.all
for pop in {FI,MV,CT,NR,NEH,GH}; do tail -n+2 $pop.het >> FIS.all; done
```

We then load this table into R
```{r}
library(tidyverse)
fis_df <- read.csv("FIS.all") %>%
  mutate(FID = recode(FID, FI = "CL1", NEH = "CL2")) %>%
  mutate(Type = ifelse(FID == "CL1" | FID == "CL2", "Commercial", "Wild"))
```

Looking to see if any Fis values are statistically significant

```{r}
library(dunn.test)
#First we test for normality using a Kolmogorov-Smirnov Test
lapply(split(fis_df$F, fis_df$FID), ks.test, "pnorm")
#The data is not normally distributed, we should proceed with a Kruskall test
kruskal.test(fis_df$F ~ fis_df$FID)
#The populations are significantly different, we should use a Dunn-Test post-hoc
dunn.test(fis_df$F, g = fis_df$FID, method  = "bonferroni")
```

Plotting Fis

```{r}
FIS <- ggplot(fis_df, aes(x=FID, y=F, fill = Type)) + geom_boxplot()+
  xlab("Population")+
  ylab(bquote(F[IS]))+
  ggtitle(bquote(F[IS]*" per Population")) + ylim(-1,1)
plot(FIS)
```

Making Histogram for Fis
```{r}
FisHist <- ggplot(aes(x=F, col=I("black"), fill=Type), data = fis_df) +   geom_histogram() +
          facet_wrap(~ FID)
plot(FisHist)
```



